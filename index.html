<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Archive Machine</title>
    <!-- <link rel="stylesheet" href="./client/client/styles/styles.css"> -->
    <!-- dependencies -->
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <!-- // <script src="./client/client/bower_components/underscore/underscore.js"></script> -->
    <!-- // <script src="./client/client/bower_components/backbone/backbone.js"></script> -->
    <!-- your scripts -->
    <!-- // <script src="./client/client/scripts/refactor.js"></script> -->
  </head>
  <body>
    <div id="main">
      <h1>Internet Archive</h1>
      <form action="#" id="send" method="post">
        <input type="text" name="url" id="url"/>
        <input type="submit" name="submit" class="submit"/>
      </form>
    </div>
    <div id="container">
    </div>
    <script>
      $(function(){
        console.log('Running jQuery Version...');
        var app = {
          server: 'https://127.0.0.1:8080',

          init: function() {
            // Cache jQuery selectors
            app.$container = $('#container');
            app.$send = $('#send');
            app.$url = $('#url');

            // Add listeners
            app.$main.on('click', '.username', app.addFriend);
            app.$send.on('submit', app.handleSubmit);

            // app.fetch(false);
          },

          send: function(data) {
            app.$message.val('');

            // POST the message to the server
            $.ajax({
              url: app.server,
              type: 'POST',
              data: JSON.stringify(data),
              contentType: 'application/json',
              success: function (data) {
                // Trigger a fetch to update the messages, pass true to animate
                app.fetch();
              },
              error: function (data) {
                console.error('chatterbox: Failed to send message');
              }
            });
          },

          fetch: function(animate) {
            $.ajax({
              url: app.server,
              type: 'GET',
              contentType: 'application/json',
              data: { order: '-createdAt'},
              success: function(data) {
                // Don't bother if we have nothing to work with
                if (!data.results || !data.results.length) { return; }

                // Get the last message
                var mostRecentMessage = data.results[data.results.length-1];
                var displayedRoom = $('.chat span').first().data('roomname');
                app.stopSpinner();
                // Only bother updating the DOM if we have a new message
                if (mostRecentMessage.objectId !== app.lastMessageId || app.roomname !== displayedRoom) {
                  // Update the UI with the fetched rooms
                  app.populateRooms(data.results);

                  // Update the UI with the fetched messages
                  app.populateMessages(data.results, animate);

                  // Store the ID of the most recent message
                  app.lastMessageId = mostRecentMessage.objectId;
                }
              },
              error: function(data) {
                console.error('chatterbox: Failed to fetch messages');
              }
            });
          },

          addMessage: function(data) {
            if (!data.roomname)
              data.roomname = 'lobby';

            // Only add messages that are in our current room
            if (data.roomname === app.roomname) {
              // Create a div to hold the chats
              var $chat = $('<div class="chat"/>');

              // Add in the message data using DOM methods to avoid XSS
              // Store the username in the element's data
              var $username = $('<span class="username"/>');
              $username.text(data.username+': ').attr('data-username', data.username).attr('data-roomname',data.roomname).appendTo($chat);

              // Add the friend class
              if (app.friends[data.username] === true)
                $username.addClass('friend');

              var $message = $('<br><span/>');
              $message.text(data.text).appendTo($chat);

              // Add the message to the UI
              app.$chats.append($chat);
            }
          },

          handleSubmit: function(evt) {
            var message = {
              username: app.username,
              text: app.$message.val(),
              roomname: app.roomname || 'lobby'
            };

            app.send(message);

            // Stop the form from submitting
            evt.preventDefault();
          },
        };
        app.init();
      });
    </script>
  </body>
</html>
